<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
  <meta charset="UTF-8" />
  <title>Backend: CO₂-Daten pflegen</title>
  <style>
	  html, body { min-height:100%; }
	  html {
	    background: url("#{resource['data:peakpx.jpg']}") no-repeat center center fixed;
	    background-size: cover;
	   }

      body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:5rem}
       body .ui-card{background:#ffffffb8}
      body .ui-panel .ui-panel-content{background:#ffffff00}
      body .ui-panel .ui-panel-titlebar{background:#ffffff00}
      body .ui-selectonemenu{background:#ffffff00}
      .page{max-width:820px;margin:auto}
      .grid{display:grid;grid-template-columns:140px 1fr;gap:12px;align-items:center}
      .footer{margin-top:24px;font-size:.9rem;color:#666}
      h2{margin-top:0}
      body .ui-button{margin: 1em}
    </style>
</h:head>

<h:body>
  <div class="page">

    <h:panelGroup rendered="#{LoginController.loggedIn}">
      <p:card>
        <h2>CO₂-Daten bearbeiten (Land + Jahr)</h2>
        <h:form id="form">
          <p:messages showDetail="true" closable="true" />
          <div class="grid">
            <!-- Land -->
            <h:outputLabel for="country" value="Land:" />
            <p:selectOneMenu id="country" value="#{AdminController.selectedCountry}" style="min-width:280px">
             <f:selectItem itemLabel="-- Bitte Land auswählen --"
                itemValue="#{null}"
                noSelectionOption="true" />
              <f:selectItems value="#{AdminController.countries}" />
              <p:ajax listener="#{AdminController.onCountryChange}" update="yr co2 info actions"/>
            </p:selectOneMenu>

            <!-- Jahr (editierbar, genau 4 Ziffern) -->
          <h:panelGroup>
            <h:outputLabel for="yr" value="Jahr:" />
            <span>
            <p:inputText id="yr"
                         value="#{AdminController.year}"
                         maxlength="4"
                         placeholder="z. B. 2025"
                         style="max-width:140px">
              <f:validateLongRange minimum="1900" maximum="2025" />
              <p:ajax event="change" 
              		  listener="#{AdminController.onYearChange}" 
              		  update="co2 info actions"
             		  />
            </p:inputText>
            <p:commandButton value="Ändern"/>
            <h:outputText value="(Bitte ein Jahr zwischen 1900 und 2025 eingeben)"/>
            </span> 
                      

            <!-- CO₂-Wert (MtCO₂) -->
            <h:outputLabel for="co2" value="CO₂ (MtCO₂):" />
            <p:inputNumber id="co2" value="#{AdminController.co2Mt}"
                           decimalPlaces="3"
                           minValue="-1.0E12" maxValue="1.0E12"
                           thousandSeparator="."
                           decimalSeparator=","
                           placeholder="z. B. 512,34" />
          </h:panelGroup>
          </div>
		
          <p:divider/>
	
          <!-- Info -->
          <h:panelGroup id="info">
            <p:panel header="Auswahl" toggleable="true" collapsed="false">
              <p>
                Jahr: <b>#{AdminController.year}</b><br/>
                CO₂ (MtCO₂): <b>#{AdminController.co2Mt}</b><br/>
                				<!-- sichtbar, wenn (geladen, aber) NICHT freigegeben -->
				<h:panelGroup rendered="#{AdminController.existingRecord and AdminController.approved == false}">
				Vorgeschlagener CO₂-Wert:<b>#{AdminController.proposedCo2Mt}</b><br/>
				Staus: <b>wartet auf Freigabe</b>
				</h:panelGroup>
              </p>
            </p:panel>
          </h:panelGroup>

          <p:divider/>

          <!-- Aktionen -->
          <h:panelGroup id="actions">
          
          <!-- Freigeben-Button nur zeigen, wenn Datensatz existiert und noch nicht freigegeben -->
			<p:commandButton value="Freigeben"
                 icon="pi pi-check"
                 action="#{AdminController.approveSelected}"         
                 update="@form :pendingForm"
                 rendered="#{LoginController.approver
                             and AdminController.existingRecord
                             and AdminController.approved == false}" />
           <!-- Normales Speichern (kein Editor ODER kein Vorschlag vorhanden) -->      
            <p:commandButton value="Speichern"
                             action="#{AdminController.save}"                             
                             icon="pi pi-save"
                             update="@form :pendingForm"
                             rendered="#{AdminController.existingRecord and AdminController.proposedCo2Mt == null}" />
           <!-- Ablehnen (nur Editor UND es gibt einen Vorschlag für den aktuellen Datensatz) -->
           <p:commandButton value="Ablehnen"
                             action="#{AdminController.save}"                             
                             icon="pi pi-trash"
                             update="@form :pendingForm"
                             rendered="#{LoginController.approver and AdminController.proposedCo2Mt != null}" />
            

            <span style="display:inline-block;width:10px"></span>

            <!-- Löschen mit Bestätigung, nur wenn Datensatz existiert -->
            <p:commandButton value="Löschen"            				 
                             icon="pi pi-trash"
                             update="@form :pendingForm"
                             styleClass="ui-button-danger"
                             rendered="#{AdminController.existingRecord and LoginController.approver}"
                             onclick="PF('confirmDlg').show(); return false;" />

            <span style="display:inline-block;width:10px"></span>

            <p:commandButton value="Logout"
                             action="#{LoginController.logout}"
                             icon="pi pi-sign-out"
                             styleClass="ui-button-secondary" />
          
          </h:panelGroup>

          <!-- Confirm Dialog -->
          <p:confirmDialog widgetVar="confirmDlg" header="Löschen bestätigen" message="Diesen Datensatz wirklich löschen?" closable="true">
            <p:commandButton value="Ja, löschen"
                             action="#{AdminController.deleteSelected}"
                             update="@form :pendingForm"
                             styleClass="ui-button-danger"
                             oncomplete="PF('confirmDlg').hide();" />
            <p:commandButton value="Abbrechen"
                             type="button"
                             styleClass="ui-button-secondary"
                             onclick="PF('confirmDlg').hide();" />
          </p:confirmDialog>

        </h:form>
      </p:card>
    
    </h:panelGroup>

    <h:panelGroup rendered="#{!LoginController.loggedIn}">
      <p:card>
        <h3>Kein Zugriff</h3>
        <p>Bitte zuerst anmelden.</p>
        <p:linkButton outcome="login" value="Zum Login" icon="pi pi-lock"/>
      </p:card>
    </h:panelGroup>

  </div>
  <!-- Pending-Liste nur für Editor -->
<h:panelGroup rendered="#{LoginController.approver}">
  <style>
    /* fixer Kasten links */
    #pendingBox {
      position: fixed;
      left: 16px;
      top: 100px;
      width: 280px;
      max-height: 60vh;
      overflow: auto;
      z-index: 50;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,.06);
      padding: 10px 10px 6px 10px;
      font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
    }
    #pendingBox h3 { margin: 6px 6px 8px 6px; font-size: 1rem; }
    #pendingBox .muted { color:#6b7280; font-size:.85rem; }
    #pendingBox .item { border:1px solid #f1f5f9; border-radius:10px; padding:6px; margin:6px; }
  </style>

  <h:form id="pendingForm">
    <div id="pendingBox">
      <h3>Zu prüfen</h3>

      <p:outputPanel rendered="#{empty AdminController.pending}">
        <div class="muted" style="margin:6px">Keine offenen Vorschläge.</div>
      </p:outputPanel>

      <p:dataList id="pendingList"
                  value="#{AdminController.pending}"
                  var="p"
                  type="none"
                  rendered="#{not empty AdminController.pending}">
        <div class="item">
          <div><b>#{p.country}</b> – #{p.year}</div>
          <div class="muted">Vorschlag: #{p.proposedCo2Mt} MtCO₂</div>
        </div>
      </p:dataList>

      <p:commandButton value="Aktualisieren"
                       icon="pi pi-refresh"
                       process="@this"
                       update="pendingForm"
                       actionListener="#{AdminController.reloadPending}"
                       styleClass="ui-button-outlined"
                       style="margin:8px 6px 2px 6px"/>
    </div>
  </h:form>

</h:panelGroup>

  
</h:body>
</html>


